"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Word2Mp3_1 = require("../../utils/Word2Mp3");
const StorageUtil_1 = require("../../utils/StorageUtil");
const WordGroup_1 = require("../../beans/WordGroup");
const AudioUtil_1 = require("../../utils/AudioUtil");
const Params_1 = require("../../beans/Params");
let audioUtil = new AudioUtil_1.AudioUtil(StorageUtil_1.StorageUtil.getParams());
var StateEnum;
(function (StateEnum) {
    StateEnum[StateEnum["STOP"] = 0] = "STOP";
    StateEnum[StateEnum["PLAY"] = 1] = "PLAY";
    StateEnum[StateEnum["PAUSE"] = 2] = "PAUSE";
})(StateEnum || (StateEnum = {}));
Page({
    data: {
        state: StateEnum,
        curState: StateEnum.STOP,
        downloadCount: 0,
        playCount: 0,
        wordGroup: new WordGroup_1.WordGroup(),
        wordGroupList: new Array(),
        showTopTips: false,
        errMsg: '',
        params: new Params_1.Params(),
        mode: Params_1.Mode,
        pron: Params_1.Pronunciation,
        show: false,
        words: [],
        word: ""
    },
    onLoad(options) {
        let groupid = options.groupid;
        let wordGroup = new WordGroup_1.WordGroup();
        let wordGroupList = StorageUtil_1.StorageUtil.getWordGroup();
        let params = StorageUtil_1.StorageUtil.getParams();
        if (wordGroupList.length === 0) {
            console.log("没有单词分组");
        }
        wordGroup = wordGroupList[0];
        for (let i = 0; i < wordGroupList.length; i++) {
            if (wordGroupList[i].getId() === groupid) {
                wordGroup = wordGroupList[i];
            }
        }
        this.setData({
            params: params,
            wordGroup: wordGroup,
            wordGroupList: wordGroupList
        });
    },
    translateState(state) {
        this.setData({
            curState: state
        });
    },
    play() {
        if (this.data.curState === StateEnum.STOP) {
            try {
                let mp3Files = new Word2Mp3_1.Word2Mp3(this.data.params);
                let that = this;
                let words = this.data.wordGroup.getList();
                if (this.data.params.getMode() === Params_1.Mode.RANDOM) {
                    words = this.shuffle(words);
                }
                this.setData({
                    show: true,
                    words: words
                });
                this.translateState(StateEnum.PLAY);
                mp3Files.getFilePaths(words, (count) => {
                    let curNumber = Math.round(count / words.length * 100);
                    that.setData({
                        downloadCount: curNumber
                    });
                }).then((paths) => {
                    console.log(paths[0]);
                    that.audioReady(paths);
                });
            }
            catch (e) {
                let that = this;
                that.setData({
                    showTopTips: true,
                    errMsg: e
                });
                setTimeout(() => {
                    that.setData({
                        showTopTips: false,
                        errMsg: ''
                    });
                }, 3000);
            }
        }
        if (this.data.curState === StateEnum.PAUSE) {
            this.translateState(StateEnum.PLAY);
            audioUtil.playOrPause();
        }
    },
    pause() {
        this.translateState(StateEnum.PAUSE);
        audioUtil.playOrPause();
    },
    audioReady(paths) {
        audioUtil.updateParams(StorageUtil_1.StorageUtil.getParams());
        audioUtil.setPaths(paths);
        audioUtil.setProccess(this.playProccess);
        audioUtil.setEnd(this.end);
        audioUtil.ready();
        audioUtil.playOrPause();
        this.setData({
            show: false
        });
    },
    playProccess(cur) {
        let curNumber = Math.round(cur / this.data.wordGroup.getList().length * 100);
        let words = this.data.words;
        let word = words[cur - 1];
        this.setData({
            word: word,
            playCount: curNumber
        });
    },
    end() {
        this.setData({
            curState: StateEnum.STOP,
            downloadCount: 0,
            playCount: 0,
            showTopTips: false,
            errMsg: ''
        });
    },
    flushParams() {
        StorageUtil_1.StorageUtil.setParams(this.data.params);
    },
    modeChange() {
        let params = this.data.params;
        if (params.getMode() === Params_1.Mode.RANDOM) {
            params.setMode(Params_1.Mode.ORDER);
        }
        else if (params.getMode() === Params_1.Mode.ORDER) {
            params.setMode(Params_1.Mode.RANDOM);
        }
        this.setData({
            params: params,
        });
        this.flushParams();
    },
    pronChange() {
        let params = this.data.params;
        if (params.getPron() === Params_1.Pronunciation.AMERICAN) {
            params.setPron(Params_1.Pronunciation.BRITISH);
        }
        else if (params.getPron() === Params_1.Pronunciation.BRITISH) {
            params.setPron(Params_1.Pronunciation.AMERICAN);
        }
        this.setData({
            params: params,
        });
        this.flushParams();
    },
    toTest() {
        wx.navigateTo({
            url: "../test/test"
        });
    },
    stop() {
        audioUtil.stop();
    },
    show() {
        this.setData({
            show: false
        });
    },
    hidden() {
        this.setData({
            show: true
        });
    },
    shuffle(words) {
        let len = words.length;
        for (let i = 0; i < len; i++) {
            let end = len - 1;
            let index = (Math.random() * (end + 1)) >> 0;
            let t = words[end];
            words[end] = words[index];
            words[index] = t;
        }
        return words;
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlzdGVuLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibGlzdGVuLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBRUEsbURBQStDO0FBQy9DLHlEQUFtRDtBQUNuRCxxREFBK0M7QUFFL0MscURBQStDO0FBQy9DLCtDQUE0RDtBQUU1RCxJQUFJLFNBQVMsR0FBYSxJQUFJLHFCQUFTLENBQUMseUJBQVcsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFBO0FBU2hFLElBQUssU0FJSjtBQUpELFdBQUssU0FBUztJQUNaLHlDQUFJLENBQUE7SUFDSix5Q0FBSSxDQUFBO0lBQ0osMkNBQUssQ0FBQTtBQUNQLENBQUMsRUFKSSxTQUFTLEtBQVQsU0FBUyxRQUliO0FBRUQsSUFBSSxDQUFDO0lBQ0gsSUFBSSxFQUFFO1FBQ0osS0FBSyxFQUFDLFNBQVM7UUFDZixRQUFRLEVBQUMsU0FBUyxDQUFDLElBQUk7UUFDdkIsYUFBYSxFQUFDLENBQUM7UUFDZixTQUFTLEVBQUMsQ0FBQztRQUNYLFNBQVMsRUFBQyxJQUFJLHFCQUFTLEVBQUU7UUFDekIsYUFBYSxFQUFDLElBQUksS0FBSyxFQUFjO1FBQ3JDLFdBQVcsRUFBQyxLQUFLO1FBQ2pCLE1BQU0sRUFBQyxFQUFFO1FBQ1QsTUFBTSxFQUFDLElBQUksZUFBTSxFQUFFO1FBQ25CLElBQUksRUFBQyxhQUFJO1FBQ1QsSUFBSSxFQUFDLHNCQUFhO1FBQ2xCLElBQUksRUFBQyxLQUFLO1FBQ1YsS0FBSyxFQUFDLEVBQUU7UUFDUixJQUFJLEVBQUMsRUFBRTtLQUNSO0lBQ0QsTUFBTSxDQUFDLE9BQVc7UUFDaEIsSUFBSSxPQUFPLEdBQVUsT0FBTyxDQUFDLE9BQU8sQ0FBQTtRQUNwQyxJQUFJLFNBQVMsR0FBYyxJQUFJLHFCQUFTLEVBQUUsQ0FBQTtRQUMxQyxJQUFJLGFBQWEsR0FBcUIseUJBQVcsQ0FBQyxZQUFZLEVBQUUsQ0FBQTtRQUNoRSxJQUFJLE1BQU0sR0FBVyx5QkFBVyxDQUFDLFNBQVMsRUFBRSxD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L+iOt+WPluW6lOeUqOWunuS+i1xyXG5pbXBvcnQgeyBXb3JkMk1wMyB9IGZyb20gJy4uLy4uL3V0aWxzL1dvcmQyTXAzJ1xyXG5pbXBvcnQge1N0b3JhZ2VVdGlsfSBmcm9tICcuLi8uLi91dGlscy9TdG9yYWdlVXRpbCdcclxuaW1wb3J0IHtXb3JkR3JvdXB9IGZyb20gJy4uLy4uL2JlYW5zL1dvcmRHcm91cCdcclxuaW1wb3J0IHtXb3JkfSBmcm9tICcuLi8uLi9iZWFucy9Xb3JkJ1xyXG5pbXBvcnQge0F1ZGlvVXRpbH0gZnJvbSAnLi4vLi4vdXRpbHMvQXVkaW9VdGlsJ1xyXG5pbXBvcnQge1BhcmFtcyxNb2RlLFByb251bmNpYXRpb259IGZyb20gJy4uLy4uL2JlYW5zL1BhcmFtcydcclxuXHJcbmxldCBhdWRpb1V0aWw6QXVkaW9VdGlsID0gbmV3IEF1ZGlvVXRpbChTdG9yYWdlVXRpbC5nZXRQYXJhbXMoKSlcclxuXHJcbi8qKlxyXG4gKiDlo7DmmI7kuobkuIDkuKrmnprkuL7nsbvlnotcclxuICog55So5p2l5Yy65YiG6aG16Z2i55qE5LiJ56eN54q25oCB77yaXHJcbiAqIDEu5YGc5q2i54q25oCB77yM5Y+q5pyJ5YGc5q2i54q25oCB5Y+v5Lul5YiH5o2i5Y2V6K+N5YiX6KGo5ZKM6K+V6Z+zXHJcbiAqIDIu5pKt5pS+54q25oCB77yM5pKt5pS+54q25oCB5Y+q6IO96YCJ5oup5pqC5YGc5ZKM5YGc5q2iXHJcbiAqIDMu5pqC5YGc54q25oCB77yM5pqC5YGc54q25oCB5Y+q6IO96YCJ5oup5pKt5pS+5ZKM5YGc5q2iXHJcbiAqL1xyXG5lbnVtIFN0YXRlRW51bXtcclxuICBTVE9QLFxyXG4gIFBMQVksXHJcbiAgUEFVU0VcclxufVxyXG5cclxuUGFnZSh7XHJcbiAgZGF0YToge1xyXG4gICAgc3RhdGU6U3RhdGVFbnVtLFxyXG4gICAgY3VyU3RhdGU6U3RhdGVFbnVtLlNUT1AsXHJcbiAgICBkb3dubG9hZENvdW50OjAsXHJcbiAgICBwbGF5Q291bnQ6MCxcclxuICAgIHdvcmRHcm91cDpuZXcgV29yZEdyb3VwKCksXHJcbiAgICB3b3JkR3JvdXBMaXN0Om5ldyBBcnJheSA8V29yZEdyb3VwPigpLFxyXG4gICAgc2hvd1RvcFRpcHM6ZmFsc2UsXHJcbiAgICBlcnJNc2c6JycsXHJcbiAgICBwYXJhbXM6bmV3IFBhcmFtcygpLFxyXG4gICAgbW9kZTpNb2RlLFxyXG4gICAgcHJvbjpQcm9udW5jaWF0aW9uLFxyXG4gICAgc2hvdzpmYWxzZSxcclxuICAgIHdvcmRzOltdLFxyXG4gICAgd29yZDpcIlwiXHJcbiAgfSxcclxuICBvbkxvYWQob3B0aW9uczphbnkpIHtcclxuICAgIGxldCBncm91cGlkOnN0cmluZyA9IG9wdGlvbnMuZ3JvdXBpZFxyXG4gICAgbGV0IHdvcmRHcm91cDogV29yZEdyb3VwID0gbmV3IFdvcmRHcm91cCgpXHJcbiAgICBsZXQgd29yZEdyb3VwTGlzdDogQXJyYXk8V29yZEdyb3VwPiA9IFN0b3JhZ2VVdGlsLmdldFdvcmRHcm91cCgpXHJcbiAgICBsZXQgcGFyYW1zOiBQYXJhbXMgPSBTdG9yYWdlVXRpbC5nZXRQYXJhbXMoKVxyXG4gICAgLy/msqHmnInljZXor43liIbnu4TnmoTmg4XlhrXkuIvvvIzmmL7npLrliY3lvoDljZXor43nrqHnkIbpobXpnaLnmoTmjInpkq5cclxuICAgIGlmICh3b3JkR3JvdXBMaXN0Lmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICBjb25zb2xlLmxvZyhcIuayoeacieWNleivjeWIhue7hFwiKVxyXG4gICAgfVxyXG4gICAgLy/pu5jorqTmmK/nrKzkuIDkuKrljZXor43liIbnu4RcclxuICAgIHdvcmRHcm91cCA9IHdvcmRHcm91cExpc3RbMF1cclxuICAgIC8v5aaC5p6c5Y+C5pWw5Lit5Lyg5LqG5Y2V6K+N5YiG57uE55qESUTvvIzliJnpgInmi6nlj4LmlbDnmoTljZXor43liIbnu4RcclxuICAgIGZvcihsZXQgaT0wO2k8d29yZEdyb3VwTGlzdC5sZW5ndGg7aSsrKXtcclxuICAgICAgaWYod29yZEdyb3VwTGlzdFtpXS5nZXRJZCgpPT09Z3JvdXBpZCl7XHJcbiAgICAgICAgd29yZEdyb3VwID0gd29yZEdyb3VwTGlzdFtpXVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICB0aGlzLnNldERhdGEhKHtcclxuICAgICAgcGFyYW1zOnBhcmFtcyxcclxuICAgICAgd29yZEdyb3VwOiB3b3JkR3JvdXAsXHJcbiAgICAgIHdvcmRHcm91cExpc3Q6IHdvcmRHcm91cExpc3RcclxuICAgIH0pXHJcbiAgfSxcclxuICB0cmFuc2xhdGVTdGF0ZShzdGF0ZTpTdGF0ZUVudW0pe1xyXG4gICAgdGhpcy5zZXREYXRhISh7XHJcbiAgICAgIGN1clN0YXRlOnN0YXRlXHJcbiAgICB9KVxyXG4gIH0sXHJcbiAgcGxheSgpe1xyXG4gICAgaWYgKHRoaXMuZGF0YS5jdXJTdGF0ZSA9PT0gU3RhdGVFbnVtLlNUT1ApIHtcclxuICAgICAgdHJ5IHtcclxuICAgICAgbGV0IG1wM0ZpbGVzOiBXb3JkMk1wMyA9IG5ldyBXb3JkMk1wMyh0aGlzLmRhdGEucGFyYW1zKVxyXG4gICAgICBsZXQgdGhhdCA9IHRoaXNcclxuICAgICAgbGV0IHdvcmRzOiBBcnJheTxXb3JkPiA9IHRoaXMuZGF0YS53b3JkR3JvdXAuZ2V0TGlzdCgpXHJcbiAgICAgIGlmICh0aGlzLmRhdGEucGFyYW1zLmdldE1vZGUoKT09PU1vZGUuUkFORE9NKSB7XHJcbiAgICAgICAgd29yZHMgPSB0aGlzLnNodWZmbGUod29yZHMpXHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5zZXREYXRhISh7XHJcbiAgICAgICAgc2hvdzp0cnVlLFxyXG4gICAgICAgIHdvcmRzOndvcmRzXHJcbiAgICAgIH0pXHJcbiAgICAgIHRoaXMudHJhbnNsYXRlU3RhdGUoU3RhdGVFbnVtLlBMQVkpXHJcbiAgICAgIG1wM0ZpbGVzLmdldEZpbGVQYXRocyh3b3JkcywgKGNvdW50OiBudW1iZXIpID0+IHtcclxuICAgICAgICBsZXQgY3VyTnVtYmVyOiBudW1iZXIgPSBNYXRoLnJvdW5kKGNvdW50IC8gd29yZHMubGVuZ3RoICogMTAwKVxyXG4gICAgICAgIHRoYXQuc2V0RGF0YSEoe1xyXG4gICAgICAgICAgZG93bmxvYWRDb3VudDogY3VyTnVtYmVyXHJcbiAgICAgICAgfSlcclxuICAgICAgfSkudGhlbigocGF0aHM6IHN0cmluZ1tdKSA9PiB7XHJcbiAgICAgICAgY29uc29sZS5sb2cocGF0aHNbMF0pXHJcbiAgICAgICAgdGhhdC5hdWRpb1JlYWR5KHBhdGhzKVxyXG4gICAgICB9KVxyXG4gICAgfWNhdGNoKGUpe1xyXG4gICAgICBsZXQgdGhhdCA9IHRoaXNcclxuICAgICAgdGhhdC5zZXREYXRhISh7XHJcbiAgICAgICAgc2hvd1RvcFRpcHM6dHJ1ZSxcclxuICAgICAgICBlcnJNc2c6ZVxyXG4gICAgICB9KVxyXG4gICAgICBzZXRUaW1lb3V0KCgpPT57XHJcbiAgICAgICAgdGhhdC5zZXREYXRhISh7XHJcbiAgICAgICAgICBzaG93VG9wVGlwczogZmFsc2UsXHJcbiAgICAgICAgICBlcnJNc2c6JydcclxuICAgICAgICB9KVxyXG4gICAgICB9LDMwMDApXHJcbiAgICB9XHJcbiAgICB9XHJcbiAgICBpZih0aGlzLmRhdGEuY3VyU3RhdGU9PT1TdGF0ZUVudW0uUEFVU0Upe1xyXG4gICAgICB0aGlzLnRyYW5zbGF0ZVN0YXRlKFN0YXRlRW51bS5QTEFZKVxyXG4gICAgICBhdWRpb1V0aWwucGxheU9yUGF1c2UoKVxyXG4gICAgfVxyXG4gIH0sXHJcbiAgcGF1c2UoKXtcclxuICAgIHRoaXMudHJhbnNsYXRlU3RhdGUoU3RhdGVFbnVtLlBBVVNFKVxyXG4gICAgYXVkaW9VdGlsLnBsYXlPclBhdXNlKClcclxuICB9LFxyXG4gIGF1ZGlvUmVhZHkocGF0aHM6IHN0cmluZ1tdKSB7XHJcbiAgICBhdWRpb1V0aWwudXBkYXRlUGFyYW1zKFN0b3JhZ2VVdGlsLmdldFBhcmFtcygpKVxyXG4gICAgYXVkaW9VdGlsLnNldFBhdGhzKHBhdGhzKVxyXG4gICAgYXVkaW9VdGlsLnNldFByb2NjZXNzKHRoaXMucGxheVByb2NjZXNzKVxyXG4gICAgYXVkaW9VdGlsLnNldEVuZCh0aGlzLmVuZClcclxuICAgIGF1ZGlvVXRpbC5yZWFkeSgpXHJcbiAgICBhdWRpb1V0aWwucGxheU9yUGF1c2UoKVxyXG4gICAgdGhpcy5zZXREYXRhISh7XHJcbiAgICAgIHNob3c6ZmFsc2VcclxuICAgIH0pXHJcbiAgfSxcclxuICBwbGF5UHJvY2Nlc3MoY3VyOm51bWJlcil7XHJcbiAgICBsZXQgY3VyTnVtYmVyOiBudW1iZXIgPSBNYXRoLnJvdW5kKGN1ciAvIHRoaXMuZGF0YS53b3JkR3JvdXAuZ2V0TGlzdCgpLmxlbmd0aCAqIDEwMClcclxuICAgIGxldCB3b3JkczpXb3JkW10gPSB0aGlzLmRhdGEud29yZHNcclxuICAgIGxldCB3b3JkOldvcmQgPSB3b3Jkc1tjdXItMV1cclxuICAgIHRoaXMuc2V0RGF0YSEoe1xyXG4gICAgICB3b3JkOndvcmQsXHJcbiAgICAgIHBsYXlDb3VudDogY3VyTnVtYmVyXHJcbiAgICB9KVxyXG4gIH0sXHJcbiAgZW5kKCl7XHJcbiAgICB0aGlzLnNldERhdGEhKHtcclxuICAgICAgY3VyU3RhdGU6U3RhdGVFbnVtLlNUT1AsXHJcbiAgICAgIGRvd25sb2FkQ291bnQ6MCxcclxuICAgICAgcGxheUNvdW50OjAsXHJcbiAgICAgIHNob3dUb3BUaXBzOiBmYWxzZSxcclxuICAgICAgZXJyTXNnOiAnJ1xyXG4gICAgfSlcclxuICB9LFxyXG4gIGZsdXNoUGFyYW1zKCkge1xyXG4gICAgU3RvcmFnZVV0aWwuc2V0UGFyYW1zKHRoaXMuZGF0YS5wYXJhbXMpXHJcbiAgfSxcclxuICBtb2RlQ2hhbmdlKCkge1xyXG4gICAgbGV0IHBhcmFtczogUGFyYW1zID0gdGhpcy5kYXRhLnBhcmFtc1xyXG4gICAgaWYgKHBhcmFtcy5nZXRNb2RlKCkgPT09IE1vZGUuUkFORE9NKSB7XHJcbiAgICAgIHBhcmFtcy5zZXRNb2RlKE1vZGUuT1JERVIpXHJcbiAgICB9IGVsc2UgaWYgKHBhcmFtcy5nZXRNb2RlKCkgPT09IE1vZGUuT1JERVIpIHtcclxuICAgICAgcGFyYW1zLnNldE1vZGUoTW9kZS5SQU5ET00pXHJcbiAgICB9XHJcbiAgICB0aGlzLnNldERhdGEhKHtcclxuICAgICAgcGFyYW1zOiBwYXJhbXMsXHJcbiAgICB9KVxyXG4gICAgdGhpcy5mbHVzaFBhcmFtcygpXHJcbiAgfSxcclxuICBwcm9uQ2hhbmdlKCkge1xyXG4gICAgbGV0IHBhcmFtczogUGFyYW1zID0gdGhpcy5kYXRhLnBhcmFtc1xyXG4gICAgaWYgKHBhcmFtcy5nZXRQcm9uKCkgPT09IFByb251bmNpYXRpb24uQU1FUklDQU4pIHtcclxuICAgICAgcGFyYW1zLnNldFByb24oUHJvbnVuY2lhdGlvbi5CUklUSVNIKVxyXG4gICAgfSBlbHNlIGlmIChwYXJhbXMuZ2V0UHJvbigpID09PSBQcm9udW5jaWF0aW9uLkJSSVRJU0gpIHtcclxuICAgICAgcGFyYW1zLnNldFByb24oUHJvbnVuY2lhdGlvbi5BTUVSSUNBTilcclxuICAgIH1cclxuICAgIHRoaXMuc2V0RGF0YSEoe1xyXG4gICAgICBwYXJhbXM6IHBhcmFtcyxcclxuICAgIH0pXHJcbiAgICB0aGlzLmZsdXNoUGFyYW1zKClcclxuICB9LFxyXG4gIHRvVGVzdCgpe1xyXG4gICAgd3gubmF2aWdhdGVUbyh7XHJcbiAgICAgIHVybDpcIi4uL3Rlc3QvdGVzdFwiXHJcbiAgICB9KVxyXG4gIH0sXHJcbiAgc3RvcCgpe1xyXG4gICAgYXVkaW9VdGlsLnN0b3AoKVxyXG4gIH0sXHJcbiAgc2hvdygpe1xyXG4gICAgdGhpcy5zZXREYXRhISh7XHJcbiAgICAgIHNob3c6ZmFsc2VcclxuICAgIH0pXHJcbiAgfSxcclxuICBoaWRkZW4oKXtcclxuICAgIHRoaXMuc2V0RGF0YSEoe1xyXG4gICAgICBzaG93OnRydWVcclxuICAgIH0pXHJcbiAgfSxcclxuICBzaHVmZmxlKHdvcmRzOiBzdHJpbmdbXSk6IHN0cmluZ1tdIHtcclxuICAgIGxldCBsZW4gPSB3b3Jkcy5sZW5ndGhcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyBpKyspIHtcclxuICAgICAgbGV0IGVuZCA9IGxlbiAtIDFcclxuICAgICAgbGV0IGluZGV4ID0gKE1hdGgucmFuZG9tKCkgKiAoZW5kICsgMSkpID4+IDBcclxuICAgICAgbGV0IHQgPSB3b3Jkc1tlbmRdXHJcbiAgICAgIHdvcmRzW2VuZF0gPSB3b3Jkc1tpbmRleF1cclxuICAgICAgd29yZHNbaW5kZXhdID0gdFxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHdvcmRzXHJcbiAgfVxyXG59KVxyXG4iXX0=