"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var Word2Mp3_1 = require("../../utils/Word2Mp3");
var StorageUtil_1 = require("../../utils/StorageUtil");
var WordGroup_1 = require("../../beans/WordGroup");
var AudioUtil_1 = require("../../utils/AudioUtil");
var Params_1 = require("../../beans/Params");
var audioUtil = new AudioUtil_1.AudioUtil(StorageUtil_1.StorageUtil.getParams());
var StateEnum;
(function (StateEnum) {
    StateEnum[StateEnum["STOP"] = 0] = "STOP";
    StateEnum[StateEnum["PLAY"] = 1] = "PLAY";
    StateEnum[StateEnum["PAUSE"] = 2] = "PAUSE";
})(StateEnum || (StateEnum = {}));
Page({
    data: {
        state: StateEnum,
        curState: StateEnum.STOP,
        downloadCount: 0,
        playCount: 0,
        wordGroup: new WordGroup_1.WordGroup(),
        wordGroupList: new Array(),
        showTopTips: false,
        errMsg: '',
        params: new Params_1.Params(),
        mode: Params_1.Mode,
        pron: Params_1.Pronunciation,
        show: false,
        words: [],
        word: ""
    },
    onLoad: function (options) {
        var groupid = options.groupid;
        var wordGroup = new WordGroup_1.WordGroup();
        var wordGroupList = StorageUtil_1.StorageUtil.getWordGroup();
        var params = StorageUtil_1.StorageUtil.getParams();
        if (wordGroupList.length === 0) {
            console.log("没有单词分组");
        }
        wordGroup = wordGroupList[0];
        for (var i = 0; i < wordGroupList.length; i++) {
            if (wordGroupList[i].getId() === groupid) {
                wordGroup = wordGroupList[i];
            }
        }
        this.setData({
            params: params,
            wordGroup: wordGroup,
            wordGroupList: wordGroupList
        });
    },
    translateState: function (state) {
        this.setData({
            curState: state
        });
    },
    play: function () {
        if (this.data.curState === StateEnum.STOP) {
            try {
                var mp3Files = new Word2Mp3_1.Word2Mp3(this.data.params);
                var that_1 = this;
                var words_1 = this.data.wordGroup.getList();
                if (this.data.params.getMode() === Params_1.Mode.RANDOM) {
                    words_1 = this.shuffle(words_1);
                }
                this.setData({
                    show: true,
                    words: words_1
                });
                this.translateState(StateEnum.PLAY);
                mp3Files.getFilePaths(words_1, function (count) {
                    var curNumber = Math.round(count / words_1.length * 100);
                    that_1.setData({
                        downloadCount: curNumber
                    });
                }).then(function (paths) {
                    console.log(paths[0]);
                    that_1.audioReady(paths);
                });
            }
            catch (e) {
                var that_2 = this;
                that_2.setData({
                    showTopTips: true,
                    errMsg: e
                });
                setTimeout(function () {
                    that_2.setData({
                        showTopTips: false,
                        errMsg: ''
                    });
                }, 3000);
            }
        }
        if (this.data.curState === StateEnum.PAUSE) {
            this.translateState(StateEnum.PLAY);
            audioUtil.playOrPause();
        }
    },
    pause: function () {
        this.translateState(StateEnum.PAUSE);
        audioUtil.playOrPause();
    },
    audioReady: function (paths) {
        audioUtil.updateParams(StorageUtil_1.StorageUtil.getParams());
        audioUtil.setPaths(paths);
        audioUtil.setProccess(this.playProccess);
        audioUtil.setEnd(this.end);
        audioUtil.ready();
        audioUtil.playOrPause();
        this.setData({
            show: false
        });
    },
    playProccess: function (cur) {
        var curNumber = Math.round(cur / this.data.wordGroup.getList().length * 100);
        var words = this.data.words;
        var word = words[cur - 1];
        this.setData({
            word: word,
            playCount: curNumber
        });
    },
    end: function () {
        this.setData({
            curState: StateEnum.STOP,
            downloadCount: 0,
            playCount: 0,
            showTopTips: false,
            errMsg: ''
        });
    },
    flushParams: function () {
        StorageUtil_1.StorageUtil.setParams(this.data.params);
    },
    modeChange: function () {
        var params = this.data.params;
        if (params.getMode() === Params_1.Mode.RANDOM) {
            params.setMode(Params_1.Mode.ORDER);
        }
        else if (params.getMode() === Params_1.Mode.ORDER) {
            params.setMode(Params_1.Mode.RANDOM);
        }
        this.setData({
            params: params,
        });
        this.flushParams();
    },
    pronChange: function () {
        var params = this.data.params;
        if (params.getPron() === Params_1.Pronunciation.AMERICAN) {
            params.setPron(Params_1.Pronunciation.BRITISH);
        }
        else if (params.getPron() === Params_1.Pronunciation.BRITISH) {
            params.setPron(Params_1.Pronunciation.AMERICAN);
        }
        this.setData({
            params: params,
        });
        this.flushParams();
    },
    toTest: function () {
        wx.navigateTo({
            url: "../test/test"
        });
    },
    stop: function () {
        audioUtil.stop();
    },
    show: function () {
        this.setData({
            show: false
        });
    },
    hidden: function () {
        this.setData({
            show: true
        });
    },
    shuffle: function (words) {
        var len = words.length;
        for (var i = 0; i < len; i++) {
            var end = len - 1;
            var index = (Math.random() * (end + 1)) >> 0;
            var t = words[end];
            words[end] = words[index];
            words[index] = t;
        }
        return words;
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlzdGVuLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibGlzdGVuLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBRUEsaURBQStDO0FBQy9DLHVEQUFtRDtBQUNuRCxtREFBK0M7QUFFL0MsbURBQStDO0FBQy9DLDZDQUE0RDtBQUU1RCxJQUFJLFNBQVMsR0FBYSxJQUFJLHFCQUFTLENBQUMseUJBQVcsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFBO0FBU2hFLElBQUssU0FJSjtBQUpELFdBQUssU0FBUztJQUNaLHlDQUFJLENBQUE7SUFDSix5Q0FBSSxDQUFBO0lBQ0osMkNBQUssQ0FBQTtBQUNQLENBQUMsRUFKSSxTQUFTLEtBQVQsU0FBUyxRQUliO0FBRUQsSUFBSSxDQUFDO0lBQ0gsSUFBSSxFQUFFO1FBQ0osS0FBSyxFQUFDLFNBQVM7UUFDZixRQUFRLEVBQUMsU0FBUyxDQUFDLElBQUk7UUFDdkIsYUFBYSxFQUFDLENBQUM7UUFDZixTQUFTLEVBQUMsQ0FBQztRQUNYLFNBQVMsRUFBQyxJQUFJLHFCQUFTLEVBQUU7UUFDekIsYUFBYSxFQUFDLElBQUksS0FBSyxFQUFjO1FBQ3JDLFdBQVcsRUFBQyxLQUFLO1FBQ2pCLE1BQU0sRUFBQyxFQUFFO1FBQ1QsTUFBTSxFQUFDLElBQUksZUFBTSxFQUFFO1FBQ25CLElBQUksRUFBQyxhQUFJO1FBQ1QsSUFBSSxFQUFDLHNCQUFhO1FBQ2xCLElBQUksRUFBQyxLQUFLO1FBQ1YsS0FBSyxFQUFDLEVBQUU7UUFDUixJQUFJLEVBQUMsRUFBRTtLQUNSO0lBQ0QsTUFBTSxFQUFOLFVBQU8sT0FBVztRQUNoQixJQUFJLE9BQU8sR0FBVSxPQUFPLENBQUMsT0FBTyxDQUFBO1FBQ3BDLElBQUksU0FBUyxHQUFjLElBQUkscUJBQVMsRUFBRSxDQUFBO1FBQzFDLElBQUksYUFBYSxHQUFxQix5QkFBVyxDQUFDLFlBQVksRUFBRSxDQUFBO1FBQ2hFLElBQUksTUFBTSxHQUFXLHlCQUFXLENBQUMsU0FBUyxF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b250ZW50IjpbIi8vaW5kZXguanNcclxuLy/ojrflj5blupTnlKjlrp7kvotcclxuaW1wb3J0IHsgV29yZDJNcDMgfSBmcm9tICcuLi8uLi91dGlscy9Xb3JkMk1wMydcclxuaW1wb3J0IHtTdG9yYWdlVXRpbH0gZnJvbSAnLi4vLi4vdXRpbHMvU3RvcmFnZVV0aWwnXHJcbmltcG9ydCB7V29yZEdyb3VwfSBmcm9tICcuLi8uLi9iZWFucy9Xb3JkR3JvdXAnXHJcbmltcG9ydCB7V29yZH0gZnJvbSAnLi4vLi4vYmVhbnMvV29yZCdcclxuaW1wb3J0IHtBdWRpb1V0aWx9IGZyb20gJy4uLy4uL3V0aWxzL0F1ZGlvVXRpbCdcclxuaW1wb3J0IHtQYXJhbXMsTW9kZSxQcm9udW5jaWF0aW9ufSBmcm9tICcuLi8uLi9iZWFucy9QYXJhbXMnXHJcblxyXG5sZXQgYXVkaW9VdGlsOkF1ZGlvVXRpbCA9IG5ldyBBdWRpb1V0aWwoU3RvcmFnZVV0aWwuZ2V0UGFyYW1zKCkpXHJcblxyXG4vKipcclxuICog5aOw5piO5LqG5LiA5Liq5p6a5Li+57G75Z6LXHJcbiAqIOeUqOadpeWMuuWIhumhtemdoueahOS4ieenjeeKtuaAge+8mlxyXG4gKiAxLuWBnOatoueKtuaAge+8jOWPquacieWBnOatoueKtuaAgeWPr+S7peWIh+aNouWNleivjeWIl+ihqOWSjOivlemfs1xyXG4gKiAyLuaSreaUvueKtuaAge+8jOaSreaUvueKtuaAgeWPquiDvemAieaLqeaaguWBnOWSjOWBnOatolxyXG4gKiAzLuaaguWBnOeKtuaAge+8jOaaguWBnOeKtuaAgeWPquiDvemAieaLqeaSreaUvuWSjOWBnOatolxyXG4gKi9cclxuZW51bSBTdGF0ZUVudW17XHJcbiAgU1RPUCxcclxuICBQTEFZLFxyXG4gIFBBVVNFXHJcbn1cclxuXHJcblBhZ2Uoe1xyXG4gIGRhdGE6IHtcclxuICAgIHN0YXRlOlN0YXRlRW51bSxcclxuICAgIGN1clN0YXRlOlN0YXRlRW51bS5TVE9QLFxyXG4gICAgZG93bmxvYWRDb3VudDowLFxyXG4gICAgcGxheUNvdW50OjAsXHJcbiAgICB3b3JkR3JvdXA6bmV3IFdvcmRHcm91cCgpLFxyXG4gICAgd29yZEdyb3VwTGlzdDpuZXcgQXJyYXkgPFdvcmRHcm91cD4oKSxcclxuICAgIHNob3dUb3BUaXBzOmZhbHNlLFxyXG4gICAgZXJyTXNnOicnLFxyXG4gICAgcGFyYW1zOm5ldyBQYXJhbXMoKSxcclxuICAgIG1vZGU6TW9kZSxcclxuICAgIHByb246UHJvbnVuY2lhdGlvbixcclxuICAgIHNob3c6ZmFsc2UsXHJcbiAgICB3b3JkczpbXSxcclxuICAgIHdvcmQ6XCJcIlxyXG4gIH0sXHJcbiAgb25Mb2FkKG9wdGlvbnM6YW55KSB7XHJcbiAgICBsZXQgZ3JvdXBpZDpzdHJpbmcgPSBvcHRpb25zLmdyb3VwaWRcclxuICAgIGxldCB3b3JkR3JvdXA6IFdvcmRHcm91cCA9IG5ldyBXb3JkR3JvdXAoKVxyXG4gICAgbGV0IHdvcmRHcm91cExpc3Q6IEFycmF5PFdvcmRHcm91cD4gPSBTdG9yYWdlVXRpbC5nZXRXb3JkR3JvdXAoKVxyXG4gICAgbGV0IHBhcmFtczogUGFyYW1zID0gU3RvcmFnZVV0aWwuZ2V0UGFyYW1zKClcclxuICAgIC8v5rKh5pyJ5Y2V6K+N5YiG57uE55qE5oOF5Ya15LiL77yM5pi+56S65YmN5b6A5Y2V6K+N566h55CG6aG16Z2i55qE5oyJ6ZKuXHJcbiAgICBpZiAod29yZEdyb3VwTGlzdC5sZW5ndGggPT09IDApIHtcclxuICAgICAgY29uc29sZS5sb2coXCLmsqHmnInljZXor43liIbnu4RcIilcclxuICAgIH1cclxuICAgIC8v6buY6K6k5piv56ys5LiA5Liq5Y2V6K+N5YiG57uEXHJcbiAgICB3b3JkR3JvdXAgPSB3b3JkR3JvdXBMaXN0WzBdXHJcbiAgICAvL+WmguaenOWPguaVsOS4reS8oOS6huWNleivjeWIhue7hOeahElE77yM5YiZ6YCJ5oup5Y+C5pWw55qE5Y2V6K+N5YiG57uEXHJcbiAgICBmb3IobGV0IGk9MDtpPHdvcmRHcm91cExpc3QubGVuZ3RoO2krKyl7XHJcbiAgICAgIGlmKHdvcmRHcm91cExpc3RbaV0uZ2V0SWQoKT09PWdyb3VwaWQpe1xyXG4gICAgICAgIHdvcmRHcm91cCA9IHdvcmRHcm91cExpc3RbaV1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgdGhpcy5zZXREYXRhISh7XHJcbiAgICAgIHBhcmFtczpwYXJhbXMsXHJcbiAgICAgIHdvcmRHcm91cDogd29yZEdyb3VwLFxyXG4gICAgICB3b3JkR3JvdXBMaXN0OiB3b3JkR3JvdXBMaXN0XHJcbiAgICB9KVxyXG4gIH0sXHJcbiAgdHJhbnNsYXRlU3RhdGUoc3RhdGU6U3RhdGVFbnVtKXtcclxuICAgIHRoaXMuc2V0RGF0YSEoe1xyXG4gICAgICBjdXJTdGF0ZTpzdGF0ZVxyXG4gICAgfSlcclxuICB9LFxyXG4gIHBsYXkoKXtcclxuICAgIGlmICh0aGlzLmRhdGEuY3VyU3RhdGUgPT09IFN0YXRlRW51bS5TVE9QKSB7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgIGxldCBtcDNGaWxlczogV29yZDJNcDMgPSBuZXcgV29yZDJNcDModGhpcy5kYXRhLnBhcmFtcylcclxuICAgICAgbGV0IHRoYXQgPSB0aGlzXHJcbiAgICAgIGxldCB3b3JkczogQXJyYXk8V29yZD4gPSB0aGlzLmRhdGEud29yZEdyb3VwLmdldExpc3QoKVxyXG4gICAgICBpZiAodGhpcy5kYXRhLnBhcmFtcy5nZXRNb2RlKCk9PT1Nb2RlLlJBTkRPTSkge1xyXG4gICAgICAgIHdvcmRzID0gdGhpcy5zaHVmZmxlKHdvcmRzKVxyXG4gICAgICB9XHJcbiAgICAgIHRoaXMuc2V0RGF0YSEoe1xyXG4gICAgICAgIHNob3c6dHJ1ZSxcclxuICAgICAgICB3b3Jkczp3b3Jkc1xyXG4gICAgICB9KVxyXG4gICAgICB0aGlzLnRyYW5zbGF0ZVN0YXRlKFN0YXRlRW51bS5QTEFZKVxyXG4gICAgICBtcDNGaWxlcy5nZXRGaWxlUGF0aHMod29yZHMsIChjb3VudDogbnVtYmVyKSA9PiB7XHJcbiAgICAgICAgbGV0IGN1ck51bWJlcjogbnVtYmVyID0gTWF0aC5yb3VuZChjb3VudCAvIHdvcmRzLmxlbmd0aCAqIDEwMClcclxuICAgICAgICB0aGF0LnNldERhdGEhKHtcclxuICAgICAgICAgIGRvd25sb2FkQ291bnQ6IGN1ck51bWJlclxyXG4gICAgICAgIH0pXHJcbiAgICAgIH0pLnRoZW4oKHBhdGhzOiBzdHJpbmdbXSkgPT4ge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKHBhdGhzWzBdKVxyXG4gICAgICAgIHRoYXQuYXVkaW9SZWFkeShwYXRocylcclxuICAgICAgfSlcclxuICAgIH1jYXRjaChlKXtcclxuICAgICAgbGV0IHRoYXQgPSB0aGlzXHJcbiAgICAgIHRoYXQuc2V0RGF0YSEoe1xyXG4gICAgICAgIHNob3dUb3BUaXBzOnRydWUsXHJcbiAgICAgICAgZXJyTXNnOmVcclxuICAgICAgfSlcclxuICAgICAgc2V0VGltZW91dCgoKT0+e1xyXG4gICAgICAgIHRoYXQuc2V0RGF0YSEoe1xyXG4gICAgICAgICAgc2hvd1RvcFRpcHM6IGZhbHNlLFxyXG4gICAgICAgICAgZXJyTXNnOicnXHJcbiAgICAgICAgfSlcclxuICAgICAgfSwzMDAwKVxyXG4gICAgfVxyXG4gICAgfVxyXG4gICAgaWYodGhpcy5kYXRhLmN1clN0YXRlPT09U3RhdGVFbnVtLlBBVVNFKXtcclxuICAgICAgdGhpcy50cmFuc2xhdGVTdGF0ZShTdGF0ZUVudW0uUExBWSlcclxuICAgICAgYXVkaW9VdGlsLnBsYXlPclBhdXNlKClcclxuICAgIH1cclxuICB9LFxyXG4gIHBhdXNlKCl7XHJcbiAgICB0aGlzLnRyYW5zbGF0ZVN0YXRlKFN0YXRlRW51bS5QQVVTRSlcclxuICAgIGF1ZGlvVXRpbC5wbGF5T3JQYXVzZSgpXHJcbiAgfSxcclxuICBhdWRpb1JlYWR5KHBhdGhzOiBzdHJpbmdbXSkge1xyXG4gICAgYXVkaW9VdGlsLnVwZGF0ZVBhcmFtcyhTdG9yYWdlVXRpbC5nZXRQYXJhbXMoKSlcclxuICAgIGF1ZGlvVXRpbC5zZXRQYXRocyhwYXRocylcclxuICAgIGF1ZGlvVXRpbC5zZXRQcm9jY2Vzcyh0aGlzLnBsYXlQcm9jY2VzcylcclxuICAgIGF1ZGlvVXRpbC5zZXRFbmQodGhpcy5lbmQpXHJcbiAgICBhdWRpb1V0aWwucmVhZHkoKVxyXG4gICAgYXVkaW9VdGlsLnBsYXlPclBhdXNlKClcclxuICAgIHRoaXMuc2V0RGF0YSEoe1xyXG4gICAgICBzaG93OmZhbHNlXHJcbiAgICB9KVxyXG4gIH0sXHJcbiAgcGxheVByb2NjZXNzKGN1cjpudW1iZXIpe1xyXG4gICAgbGV0IGN1ck51bWJlcjogbnVtYmVyID0gTWF0aC5yb3VuZChjdXIgLyB0aGlzLmRhdGEud29yZEdyb3VwLmdldExpc3QoKS5sZW5ndGggKiAxMDApXHJcbiAgICBsZXQgd29yZHM6V29yZFtdID0gdGhpcy5kYXRhLndvcmRzXHJcbiAgICBsZXQgd29yZDpXb3JkID0gd29yZHNbY3VyLTFdXHJcbiAgICB0aGlzLnNldERhdGEhKHtcclxuICAgICAgd29yZDp3b3JkLFxyXG4gICAgICBwbGF5Q291bnQ6IGN1ck51bWJlclxyXG4gICAgfSlcclxuICB9LFxyXG4gIGVuZCgpe1xyXG4gICAgdGhpcy5zZXREYXRhISh7XHJcbiAgICAgIGN1clN0YXRlOlN0YXRlRW51bS5TVE9QLFxyXG4gICAgICBkb3dubG9hZENvdW50OjAsXHJcbiAgICAgIHBsYXlDb3VudDowLFxyXG4gICAgICBzaG93VG9wVGlwczogZmFsc2UsXHJcbiAgICAgIGVyck1zZzogJydcclxuICAgIH0pXHJcbiAgfSxcclxuICBmbHVzaFBhcmFtcygpIHtcclxuICAgIFN0b3JhZ2VVdGlsLnNldFBhcmFtcyh0aGlzLmRhdGEucGFyYW1zKVxyXG4gIH0sXHJcbiAgbW9kZUNoYW5nZSgpIHtcclxuICAgIGxldCBwYXJhbXM6IFBhcmFtcyA9IHRoaXMuZGF0YS5wYXJhbXNcclxuICAgIGlmIChwYXJhbXMuZ2V0TW9kZSgpID09PSBNb2RlLlJBTkRPTSkge1xyXG4gICAgICBwYXJhbXMuc2V0TW9kZShNb2RlLk9SREVSKVxyXG4gICAgfSBlbHNlIGlmIChwYXJhbXMuZ2V0TW9kZSgpID09PSBNb2RlLk9SREVSKSB7XHJcbiAgICAgIHBhcmFtcy5zZXRNb2RlKE1vZGUuUkFORE9NKVxyXG4gICAgfVxyXG4gICAgdGhpcy5zZXREYXRhISh7XHJcbiAgICAgIHBhcmFtczogcGFyYW1zLFxyXG4gICAgfSlcclxuICAgIHRoaXMuZmx1c2hQYXJhbXMoKVxyXG4gIH0sXHJcbiAgcHJvbkNoYW5nZSgpIHtcclxuICAgIGxldCBwYXJhbXM6IFBhcmFtcyA9IHRoaXMuZGF0YS5wYXJhbXNcclxuICAgIGlmIChwYXJhbXMuZ2V0UHJvbigpID09PSBQcm9udW5jaWF0aW9uLkFNRVJJQ0FOKSB7XHJcbiAgICAgIHBhcmFtcy5zZXRQcm9uKFByb251bmNpYXRpb24uQlJJVElTSClcclxuICAgIH0gZWxzZSBpZiAocGFyYW1zLmdldFByb24oKSA9PT0gUHJvbnVuY2lhdGlvbi5CUklUSVNIKSB7XHJcbiAgICAgIHBhcmFtcy5zZXRQcm9uKFByb251bmNpYXRpb24uQU1FUklDQU4pXHJcbiAgICB9XHJcbiAgICB0aGlzLnNldERhdGEhKHtcclxuICAgICAgcGFyYW1zOiBwYXJhbXMsXHJcbiAgICB9KVxyXG4gICAgdGhpcy5mbHVzaFBhcmFtcygpXHJcbiAgfSxcclxuICB0b1Rlc3QoKXtcclxuICAgIHd4Lm5hdmlnYXRlVG8oe1xyXG4gICAgICB1cmw6XCIuLi90ZXN0L3Rlc3RcIlxyXG4gICAgfSlcclxuICB9LFxyXG4gIHN0b3AoKXtcclxuICAgIGF1ZGlvVXRpbC5zdG9wKClcclxuICB9LFxyXG4gIHNob3coKXtcclxuICAgIHRoaXMuc2V0RGF0YSEoe1xyXG4gICAgICBzaG93OmZhbHNlXHJcbiAgICB9KVxyXG4gIH0sXHJcbiAgaGlkZGVuKCl7XHJcbiAgICB0aGlzLnNldERhdGEhKHtcclxuICAgICAgc2hvdzp0cnVlXHJcbiAgICB9KVxyXG4gIH0sXHJcbiAgc2h1ZmZsZSh3b3Jkczogc3RyaW5nW10pOiBzdHJpbmdbXSB7XHJcbiAgICBsZXQgbGVuID0gd29yZHMubGVuZ3RoXHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSB7XHJcbiAgICAgIGxldCBlbmQgPSBsZW4gLSAxXHJcbiAgICAgIGxldCBpbmRleCA9IChNYXRoLnJhbmRvbSgpICogKGVuZCArIDEpKSA+PiAwXHJcbiAgICAgIGxldCB0ID0gd29yZHNbZW5kXVxyXG4gICAgICB3b3Jkc1tlbmRdID0gd29yZHNbaW5kZXhdXHJcbiAgICAgIHdvcmRzW2luZGV4XSA9IHRcclxuICAgIH1cclxuICAgIHJldHVybiB3b3Jkc1xyXG4gIH1cclxufSlcclxuIl19