"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var util_1 = require("./util");
var CallQueue = (function () {
    function CallQueue() {
        this.length = 0;
        this._max = 1000;
        this._first = 0;
    }
    CallQueue.prototype.push = function (callback, arg) {
        this[this.length++] = callback;
        this[this.length++] = arg;
        return this.length < this._max;
    };
    CallQueue.prototype.flush = function () {
        while (this._first < this.length) {
            var callback = this[this._first];
            var arg = this[this._first + 1];
            this[this._first] = this[this._first + 1] = undefined;
            this._first += 2;
            callback(arg);
        }
        this.length = 0;
        this._first = 0;
    };
    CallQueue.prototype.empty = function () {
        return this._first === this.length;
    };
    return CallQueue;
}());
var Ring = (function () {
    function Ring(pool) {
        this._ring = [new CallQueue()];
        this._current = this._ring[0];
        this._pool = pool;
    }
    Ring.prototype.enqueue = function (callback, arg) {
        if (!this._current) {
            this._current = this._pool.pop();
            if (!this._current) {
                this._current = new CallQueue();
            }
            this._ring.push(this._current);
        }
        if (!this._current.push(callback, arg)) {
            this._current = undefined;
        }
    };
    Ring.prototype.flush = function () {
        while (true) {
            this._ring[0].flush();
            if (this._ring.length === 1) {
                break;
            }
            this._pool.push(this._ring.shift());
        }
        this._current = this._ring[0];
    };
    Ring.prototype.empty = function () {
        return this._ring.length === 1 && this._ring[0].empty();
    };
    return Ring;
}());
function defaultScheduler(callback) {
    if (typeof setImmediate === "function") {
        setImmediate(callback);
    }
    else {
        setTimeout(callback, 0);
    }
}
var Async = (function () {
    function Async() {
        var _this = this;
        this._pool = [];
        this._mainRing = new Ring(this._pool);
        this._idleRing = new Ring(this._pool);
        this._flushing = false;
        this._scheduled = false;
        this._scheduler = undefined;
        this._flusher = function () { return _this._scheduledFlush(); };
    }
    Async.prototype.setScheduler = function (scheduler) {
        util_1.assert(scheduler === undefined || scheduler === null || typeof scheduler === "function");
        this._scheduler = scheduler;
    };
    Async.prototype.enqueue = function (callback, arg) {
        if (!this._flushing && !this._scheduled) {
            this._schedule();
        }
        this._mainRing.enqueue(callback, arg);
    };
    Async.prototype.enqueueIdle = function (callback, arg) {
        if (!this._flushing && !this._scheduled) {
            this._schedule();
        }
        this._idleRing.enqueue(callback, arg);
    };
    Async.prototype.flush = function () {
        util_1.assert(!this._flushing, "cannot recursively flush");
        this._flushing = true;
        try {
            while (true) {
                this._mainRing.flush();
                if (this._idleRing.empty()) {
                    break;
                }
                var emptyRing = this._mainRing;
                this._mainRing = this._idleRing;
                this._idleRing = emptyRing;
            }
        }
        finally {
            this._flushing = false;
            if ((!this._mainRing.empty() || !this._idleRing.empty()) && !this._scheduled) {
                this._schedule();
            }
        }
    };
    Async.prototype._schedule = function () {
        util_1.assert(!this._scheduled);
        var scheduler = this._scheduler || defaultScheduler;
        scheduler(this._flusher);
        this._scheduled = true;
    };
    Async.prototype._scheduledFlush = function () {
        this._scheduled = false;
        this.flush();
    };
    return Async;
}());
exports.Async = Async;
exports.async = new Async();
exports.default = exports.async;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXN5bmMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJhc3luYy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQVNBLCtCQUFnQztBQUVoQztJQUFBO1FBRVEsV0FBTSxHQUFXLENBQUMsQ0FBQztRQUdsQixTQUFJLEdBQVcsSUFBSSxDQUFDO1FBQ3BCLFdBQU0sR0FBVyxDQUFDLENBQUM7SUFpQzVCLENBQUM7SUEzQk8sd0JBQUksR0FBWCxVQUFZLFFBQTRCLEVBQUUsR0FBUTtRQUNqRCxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsUUFBUSxDQUFDO1FBQy9CLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUM7UUFDMUIsT0FBTyxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7SUFDaEMsQ0FBQztJQVFNLHlCQUFLLEdBQVo7UUFDQyxPQUFPLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNqQyxJQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ25DLElBQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ2xDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLEdBQUcsU0FBUyxDQUFDO1lBQ3RELElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxDQUFDO1lBQ2pCLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUNkO1FBQ0QsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7UUFDaEIsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7SUFDakIsQ0FBQztJQUVNLHlCQUFLLEdBQVo7UUFDQyxPQUFPLElBQUksQ0FBQyxNQUFNLEtBQUssSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUNwQyxDQUFDO0lBQ0YsZ0JBQUM7QUFBRCxDQUFDLEFBdkNELElBdUNDO0FBRUQ7SUFrQkMsY0FBWSxJQUFpQjtRQVJyQixVQUFLLEdBQWdCLENBQUMsSUFBSSxTQUFTLEVBQUUsQ0FBQyxDQUFDO1FBTXZDLGFBQVEsR0FBMEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUd2RCxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztJQUNuQixDQUFDO0lBUU0sc0JBQU8sR0FBZCxVQUFlLFFBQTRCLEVBQUUsR0FBUztRQUdyRCxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNuQixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDakMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUU7Z0JBQ25CLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxTQUFTLEVBQUUsQ0FBQzthQUNoQztZQUNELElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUMvQjtRQUVELElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLEVBQUU7WUFFdkMsSUFBSSxDQUFDLFFBQVEsR0FBRyxTQUFTLENBQUM7U0FDMUI7SUFDRixDQUFDO0lBUU0sb0JBQUssR0FBWjtRQUNDLE9BQU8sSUFBSSxFQUFFO1lBR1osSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUd0QixJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtnQkFDNUIsTUFBTTthQUNOO1lBT0QsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUcsQ0FBQyxDQUFDO1NBQ3JDO1FBT0QsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQy9CLENBQUM7SUFLTSxvQkFBSyxHQUFaO1FBQ0MsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sS0FBSyxDQUFDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUN6RCxDQUFDO0lBQ0YsV0FBQztBQUFELENBQUMsQUFwRkQsSUFvRkM7QUFFRCxTQUFTLGdCQUFnQixDQUFDLFFBQW9CO0lBSzdDLElBQUksT0FBTyxZQUFZLEtBQUssVUFBVSxFQUFFO1FBQ3ZDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztLQUN2QjtTQUFNO1FBQ04sVUFBVSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQztLQUN4QjtBQUNGLENBQUM7QUFFRDtJQUFBO1FBQUEsaUJBNkhDO1FBNUhRLFVBQUssR0FBZ0IsRUFBRSxDQUFDO1FBQ3hCLGNBQVMsR0FBUyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDdkMsY0FBUyxHQUFTLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN2QyxjQUFTLEdBQVksS0FBSyxDQUFDO1FBQzNCLGVBQVUsR0FBWSxLQUFLLENBQUM7UUFDNUIsZUFBVSxHQUFvQyxTQUFTLENBQUM7UUF3R3hELGFBQVEsR0FBZSxjQUFNLE9BQUEsS0FBSSxDQUFDLGVBQWUsRUFBRSxFQUF0QixDQUFzQixDQUFDO0lBZTdELENBQUM7SUF2R08sNEJBQVksR0FBbkIsVUFBb0IsU0FBc0Q7UUFFekUsYUFBTSxDQUFDLFNBQVMsS0FBSyxTQUFTLElBQUksU0FBUyxLQUFLLElBQUksSUFBSSxPQUFPLFNBQVMsS0FBSyxVQUFVLENBQUMsQ0FBQztRQUV6RixJQUFJLENBQUMsVUFBVSxHQUFHLFNBQVMsQ0FBQztJQUM3QixDQUFDO0lBYU0sdUJBQU8sR0FBZCxVQUFlLFFBQTRCLEVBQUUsR0FBUztRQUNyRCxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDeEMsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1NBQ2pCO1FBQ0QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3ZDLENBQUM7SUFhTSwyQkFBVyxHQUFsQixVQUFtQixRQUE0QixFQUFFLEdBQVM7UUFDekQsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ3hDLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztTQUNqQjtRQUNELElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUN2QyxDQUFDO0lBVU0scUJBQUssR0FBWjtRQUNDLGFBQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsMEJBQTBCLENBQUMsQ0FBQztRQUNwRCxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztRQUN0QixJQUFJO1lBQ0gsT0FBTyxJQUFJLEVBQUU7Z0JBQ1osSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztnQkFDdkIsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxFQUFFO29CQUUzQixNQUFNO2lCQUNOO2dCQU9ELElBQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUM7Z0JBQ2pDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztnQkFDaEMsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7YUFDM0I7U0FDRDtnQkFBUztZQUNULElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO1lBVXZCLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFO2dCQUM3RSxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7YUFDakI7U0FDRDtJQUNGLENBQUM7SUFJTyx5QkFBUyxHQUFqQjtRQUNDLGFBQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN6QixJQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsVUFBVSxJQUFJLGdCQUFnQixDQUFDO1FBRXRELFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDekIsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7SUFDeEIsQ0FBQztJQUVPLCtCQUFlLEdBQXZCO1FBRUMsSUFBSSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUM7UUFDeEIsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ2QsQ0FBQztJQUNGLFlBQUM7QUFBRCxDQUFDLEFBN0hELElBNkhDO0FBN0hZLHNCQUFLO0FBK0hQLFFBQUEsS0FBSyxHQUFHLElBQUksS0FBSyxFQUFFLENBQUM7QUFDL0Isa0JBQWUsYUFBSyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDYWxsIHF1ZXVlIGZvciBleGVjdXRpbmcgY2FsbGJhY2tzIGFzeW5jaHJvbm91c2x5LlxuICpcbiAqIFByZXZlbnRzIHJlbGVhc2luZyBaYWxnby5cbiAqXG4gKiBDb3B5cmlnaHQgKEMpIDIwMTUgTWFydGluIFBvZWxzdHJhXG4gKiBMaWNlbnNlOiBNSVRcbiAqL1xuXG5pbXBvcnQgeyBhc3NlcnQgfSBmcm9tIFwiLi91dGlsXCI7XG5cbmNsYXNzIENhbGxRdWV1ZSB7XG5cdFtpbmRleDogbnVtYmVyXTogYW55O1xuXHRwdWJsaWMgbGVuZ3RoOiBudW1iZXIgPSAwO1xuXG5cdC8vIEJhc2ljYWxseSB0d2ljZSB0aGUgbnVtYmVyIG9mIHNpbXVsdGFuZW91c2x5IHJlc29sdmluZyBwcm9taXNlc1xuXHRwcml2YXRlIF9tYXg6IG51bWJlciA9IDEwMDA7XG5cdHByaXZhdGUgX2ZpcnN0OiBudW1iZXIgPSAwO1xuXG5cdC8qKlxuXHQgKiBQdXNoIGEgbmV3IGNhbGxiYWNrIHRvIHRoZSBxdWV1ZS5cblx0ICogQHJldHVybiB0cnVlIHdoZW4gdGhlIHF1ZXVlIHN0aWxsIGhhcyBzcGFjZSwgZmFsc2UgaWYgaXQncyBub3cgJ2Z1bGwnXG5cdCAqL1xuXHRwdWJsaWMgcHVzaChjYWxsYmFjazogKGFyZzogYW55KSA9PiB2b2lkLCBhcmc6IGFueSk6IGJvb2xlYW4ge1xuXHRcdHRoaXNbdGhpcy5sZW5ndGgrK10gPSBjYWxsYmFjaztcblx0XHR0aGlzW3RoaXMubGVuZ3RoKytdID0gYXJnO1xuXHRcdHJldHVybiB0aGlzLmxlbmd0aCA8IHRoaXMuX21heDtcblx0fVxuXG5cdC8qKlxuXHQgKiBGbHVzaCBhbGwgY2FsbGJhY2tzIGluIHRoaXMgcXVldWUuXG5cdCAqIE5vdGUgdGhhdCBpdCBpcyAnb2snIGZvciBjYWxsYmFja3MgdG8gdGhyb3cgYW4gZXJyb3I7XG5cdCAqIHRoZSBuZXh0IGNhbGwgdG8gZmx1c2goKSB3aWxsIGZsdXNoIHRoZSByZW1haW5kZXIgb2YgdGhlIHF1ZXVlLlxuXHQgKiBXaGVuIHRoaXMgZnVuY3Rpb24gcmV0dXJucywgdGhlIHF1ZXVlIHdpbGwgYmUgJ3Jlc2V0JyB0byBpdHMgYmVnaW5uaW5nLlxuXHQgKi9cblx0cHVibGljIGZsdXNoKCk6IHZvaWQge1xuXHRcdHdoaWxlICh0aGlzLl9maXJzdCA8IHRoaXMubGVuZ3RoKSB7XG5cdFx0XHRjb25zdCBjYWxsYmFjayA9IHRoaXNbdGhpcy5fZmlyc3RdO1xuXHRcdFx0Y29uc3QgYXJnID0gdGhpc1t0aGlzLl9maXJzdCArIDFdO1xuXHRcdFx0dGhpc1t0aGlzLl9maXJzdF0gPSB0aGlzW3RoaXMuX2ZpcnN0ICsgMV0gPSB1bmRlZmluZWQ7XG5cdFx0XHR0aGlzLl9maXJzdCArPSAyO1xuXHRcdFx0Y2FsbGJhY2soYXJnKTtcblx0XHR9XG5cdFx0dGhpcy5sZW5ndGggPSAwO1xuXHRcdHRoaXMuX2ZpcnN0ID0gMDtcblx0fVxuXG5cdHB1YmxpYyBlbXB0eSgpOiBib29sZWFuIHtcblx0XHRyZXR1cm4gdGhpcy5fZmlyc3QgPT09IHRoaXMubGVuZ3RoO1xuXHR9XG59XG5cbmNsYXNzIFJpbmcge1xuXHQvKipcblx0ICogUmVmZXJlbmNlIHRvIHNoYXJlZCBwb29sIG9mIHJldXNhYmxlIHF1ZXVlcywgb3duZWQgYnkgb3VyIG93bmVyIChgQXN5bmNgKS5cblx0ICovXG5cdHByaXZhdGUgX3Bvb2w6IENhbGxRdWV1ZVtdO1xuXG5cdC8qKlxuXHQgKiBSaW5nIG9mIHF1ZXVlcy5cblx0ICogR3VhcmFudGVlZCB0byBhbHdheXMgY29udGFpbiBhdCBsZWFzdCBvbmUgcXVldWUuXG5cdCAqL1xuXHRwcml2YXRlIF9yaW5nOiBDYWxsUXVldWVbXSA9IFtuZXcgQ2FsbFF1ZXVlKCldO1xuXG5cdC8qKlxuXHQgKiBRdWV1ZSB0byBwdXQgbmV3IGNhbGxiYWNrcyBpbiwgaS5lLiB0aGUgbGFzdCBxdWV1ZSBpbiB0aGUgcmluZy5cblx0ICogSWYgYHVuZGVmaW5lZGAsIGEgbmV3IHF1ZXVlIHdpbGwgYmUgb2J0YWluZWQgYW5kIGFkZGVkIHRvIHJpbmcgb24gbmV4dCBlbnF1ZXVlLlxuXHQgKi9cblx0cHJpdmF0ZSBfY3VycmVudDogQ2FsbFF1ZXVlIHwgdW5kZWZpbmVkID0gdGhpcy5fcmluZ1swXTtcblxuXHRjb25zdHJ1Y3Rvcihwb29sOiBDYWxsUXVldWVbXSkge1xuXHRcdHRoaXMuX3Bvb2wgPSBwb29sO1xuXHR9XG5cblx0LyoqXG5cdCAqIEFkZCBjYWxsYmFjayAoYW5kIG9wdGlvbmFsIGFyZ3VtZW50KSB0byBsYXN0IHF1ZXVlIGluIHJpbmcuXG5cdCAqIEF1dG9tYXRpY2FsbHkgb2J0YWlucyBuZXcgcXVldWUgaWYgY3VycmVudCBxdWV1ZSBpcyBmdWxsLlxuXHQgKi9cblx0cHVibGljIGVucXVldWUoY2FsbGJhY2s6ICgpID0+IHZvaWQpOiB2b2lkO1xuXHRwdWJsaWMgZW5xdWV1ZTxUPihjYWxsYmFjazogKGFyZzogVCkgPT4gdm9pZCwgYXJnOiBUKTogdm9pZDtcblx0cHVibGljIGVucXVldWUoY2FsbGJhY2s6IChhcmc6IGFueSkgPT4gdm9pZCwgYXJnPzogYW55KTogdm9pZCB7XG5cdFx0Ly8gTWFrZSBzdXJlIHRoaXMuX2N1cnJlbnQgcG9pbnRzIHRvIGEgcXVldWU6IG9idGFpbiBvbmVcblx0XHQvLyBmcm9tIHBvb2wgb3IgY3JlYXRlIGEgbmV3IG9uZSBpZiBuZWNlc3NhcnkuXG5cdFx0aWYgKCF0aGlzLl9jdXJyZW50KSB7XG5cdFx0XHR0aGlzLl9jdXJyZW50ID0gdGhpcy5fcG9vbC5wb3AoKTtcblx0XHRcdGlmICghdGhpcy5fY3VycmVudCkge1xuXHRcdFx0XHR0aGlzLl9jdXJyZW50ID0gbmV3IENhbGxRdWV1ZSgpO1xuXHRcdFx0fVxuXHRcdFx0dGhpcy5fcmluZy5wdXNoKHRoaXMuX2N1cnJlbnQpO1xuXHRcdH1cblx0XHQvLyBBZGQgY2FsbGJhY2sgdG8gcXVldWVcblx0XHRpZiAoIXRoaXMuX2N1cnJlbnQucHVzaChjYWxsYmFjaywgYXJnKSkge1xuXHRcdFx0Ly8gUXVldWUgZnVsbCwgbG9hZCBhIG5ldyBvbmUgbmV4dCB0aW1lXG5cdFx0XHR0aGlzLl9jdXJyZW50ID0gdW5kZWZpbmVkO1xuXHRcdH1cblx0fVxuXG5cdC8qKlxuXHQgKiBDYWxsIGFsbCBjYWxsYmFja3MgaW4gYWxsIHF1ZXVlcyBpbiB0aGlzIHJpbmcsIHVudGlsIGl0IGlzIGVtcHR5LlxuXHQgKiBOb3RlOiBpdCBpcyAnT0snIGZvciBhIGNhbGxiYWNrIHRvIHRocm93IGFuIGVycm9yOyByaW5nL3F1ZXVlIHN0YXRlXG5cdCAqIHdpbGwgcmVtYWluIHZhbGlkIGFuZCByZW1haW5pbmcgaXRlbXMgd2lsbCBiZSBmbHVzaGVkIG9uIG5leHQgY2FsbFxuXHQgKiB0byBgZmx1c2goKWAuXG5cdCAqL1xuXHRwdWJsaWMgZmx1c2goKTogdm9pZCB7XG5cdFx0d2hpbGUgKHRydWUpIHtcblx0XHRcdC8vIFJpbmcgaXMgZ3VhcmFudGVlZCB0byBoYXZlIGF0IGxlYXN0IG9uZSBxdWV1ZSAoZXZlbiB0aG91Z2hcblx0XHRcdC8vIHF1ZXVlIG1pZ2h0IGJlIGVtcHR5IHdoZW4gZmx1c2goKSBpcyBlLmcuIGNhbGxlZCBtYW51YWxseSkuXG5cdFx0XHR0aGlzLl9yaW5nWzBdLmZsdXNoKCk7XG5cblx0XHRcdC8vIElmIHRoaXMgaXMgdGhlIGxhc3QgcXVldWUgaW4gdGhlIHJpbmcsIHdlJ3JlIGRvbmVcblx0XHRcdGlmICh0aGlzLl9yaW5nLmxlbmd0aCA9PT0gMSkge1xuXHRcdFx0XHRicmVhaztcblx0XHRcdH1cblxuXHRcdFx0Ly8gU2hpZnQgdGhlIG5vdyBlbXB0eSByaW5nIGludG8gcG9vbC5cblx0XHRcdC8vIFF1ZXVlIGF0IGluZGV4IDAgaXMgZW1wdHksIGFuZCByaW5nIGxlbmd0aCA+PSAyLlxuXHRcdFx0Ly8gU28sIHRoaXMuX2N1cnJlbnQgaXMgZ3VhcmFudGVlZCB0byBwb2ludCB0byBzb21ldGhpbmcgJ2xhdGVyJ1xuXHRcdFx0Ly8gdGhhbiBxdWV1ZSBhdCBpbmRleCAwLCBhbmQgd2UgY2FuIHNhZmVseSBtb3ZlIGluZGV4IDAgdG8gdGhlXG5cdFx0XHQvLyBwb29sLlxuXHRcdFx0dGhpcy5fcG9vbC5wdXNoKHRoaXMuX3Jpbmcuc2hpZnQoKSEpO1xuXHRcdH1cblxuXHRcdC8vIFJpbmcgaXMgbm93IGd1YXJhbnRlZWQgdG8gY29udGFpbiBvbmx5IGEgc2luZ2xlLCBlbXB0eSBxdWV1ZSwgc28gd2Vcblx0XHQvLyBjb3VsZCBtb3ZlIGl0IHRvIHRoZSBwb29sLlxuXHRcdC8vIEhvd2V2ZXIsIGJlY2F1c2UgaXQncyB0aGUgbGFzdCBpdGVtIHJlbWFpbmluZywgYmV0dGVyIHRvIHNpbXBseVxuXHRcdC8vIGxlYXZlIGl0IGluIHRoZSByaW5nLCBzYXZlcyB1bm5lY2Vzc2FyeSByZS1tb3ZlIG9uIG5leHQgZW5xdWV1ZS5cblx0XHQvLyBBbHNvLCBtYWtlIHN1cmUgdGhhdCBuZXcgaXRlbXMgd2lsbCBiZSBsb2FkZWQgaW50byB0aGF0IHF1ZXVlLlxuXHRcdHRoaXMuX2N1cnJlbnQgPSB0aGlzLl9yaW5nWzBdO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybiB0cnVlIGlmIG5vIGNhbGxiYWNrcyBhcmUgZW5xdWV1ZWQgaW4gdGhpcyByaW5nLlxuXHQgKi9cblx0cHVibGljIGVtcHR5KCk6IGJvb2xlYW4ge1xuXHRcdHJldHVybiB0aGlzLl9yaW5nLmxlbmd0aCA9PT0gMSAmJiB0aGlzLl9yaW5nWzBdLmVtcHR5KCk7XG5cdH1cbn1cblxuZnVuY3Rpb24gZGVmYXVsdFNjaGVkdWxlcihjYWxsYmFjazogKCkgPT4gdm9pZCk6IHZvaWQge1xuXHQvLyBOb3RlOiB3ZSBleHBsaWNpdGx5IHJlLWNoZWNrIHR5cGVzIGFuZCBjYWxsIGl0IGhlcmUgKGluc3RlYWQgb2Zcblx0Ly8gZS5nLiBhc3NpZ25pbmcgaXQgdG8gYSB2YXJpYWJsZSBvbmNlIGF0IHN0YXJ0dXApLCB0byBhbGxvd1xuXHQvLyBzZXRJbW1lZGlhdGUgLyBzZXRUaW1lb3V0IHRvIGJlIHJlcGxhY2VkIGJ5IG1vY2tlZCBvbmVzXG5cdC8vIChlLmcuIFNpbm9uJ3MgdXNlRmFrZVRpbWVycygpKVxuXHRpZiAodHlwZW9mIHNldEltbWVkaWF0ZSA9PT0gXCJmdW5jdGlvblwiKSB7XG5cdFx0c2V0SW1tZWRpYXRlKGNhbGxiYWNrKTtcblx0fSBlbHNlIHtcblx0XHRzZXRUaW1lb3V0KGNhbGxiYWNrLCAwKTtcblx0fVxufVxuXG5leHBvcnQgY2xhc3MgQXN5bmMge1xuXHRwcml2YXRlIF9wb29sOiBDYWxsUXVldWVbXSA9IFtdO1xuXHRwcml2YXRlIF9tYWluUmluZzogUmluZyA9IG5ldyBSaW5nKHRoaXMuX3Bvb2wpO1xuXHRwcml2YXRlIF9pZGxlUmluZzogUmluZyA9IG5ldyBSaW5nKHRoaXMuX3Bvb2wpO1xuXHRwcml2YXRlIF9mbHVzaGluZzogYm9vbGVhbiA9IGZhbHNlO1xuXHRwcml2YXRlIF9zY2hlZHVsZWQ6IGJvb2xlYW4gPSBmYWxzZTtcblx0cHJpdmF0ZSBfc2NoZWR1bGVyPzogKGNhbGxiYWNrOiAoKSA9PiB2b2lkKSA9PiB2b2lkID0gdW5kZWZpbmVkO1xuXG5cdC8qKlxuXHQgKiBDb25maWd1cmUgYWx0ZXJuYXRpdmUgc2NoZWR1bGVyIHRvIHVzZS5cblx0ICogVGhlIHNjaGVkdWxlciBmdW5jdGlvbiB3aWxsIGJlIGNhbGxlZCB3aXRoIGEgZmx1c2hlciwgd2hpY2ggbmVlZHMgdG8gYmVcblx0ICogZXhlY3V0ZWQgdG8gZmx1c2ggdGhlIHF1ZXVlLiBOb3RlOiB0aGUgZmx1c2hlciBtYXkgdGhyb3cgYW5cblx0ICogZXhjZXB0aW9uLCBpZiBhbnkgb2YgdGhlIGNhbGxiYWNrcyBvbiB0aGUgcXVldWUgdGhyb3dzIG9uZS5cblx0ICogVGhpcyB3aWxsIHJlc3VsdCBpbiBhbm90aGVyIGZsdXNoIHRvIGJlIHNjaGVkdWxlZCBiZWZvcmUgcmV0dXJuaW5nLlxuXHQgKlxuXHQgKiBDYWxsIHdpdGggYHVuZGVmaW5lZGAgdG8gcmVzZXQgdGhlIHNjaGVkdWxlciB0byB0aGUgZGVmYXVsdCAoc2V0SW1tZWRpYXRlKS5cblx0ICpcblx0ICogRXhhbXBsZSB1c2FnZSAodGhpcyBpcyBiYXNpY2FsbHkgdGhlIGRlZmF1bHQpOlxuXHQgKiAgIHNldFNjaGVkdWxlcigoZmx1c2hlcikgPT4gc2V0SW1tZWRpYXRlKGZsdXNoZXIpKTtcblx0ICogTm90ZTogdGhpcyBpcyBzbGlnaHRseSBkaWZmZXJlbnQgZnJvbSBqdXN0IHNldFNjaGVkdWxlcihzZXRJbW1lZGlhdGUpLCBpbiB0aGF0XG5cdCAqIHRoZSBmb3JtZXIgYWxsb3dzIG92ZXJyaWRpbmcgc2V0SW1tZWRpYXRlIGluIGUuZy4gdW5pdCB0ZXN0cy5cblx0ICovXG5cdHB1YmxpYyBzZXRTY2hlZHVsZXIoc2NoZWR1bGVyOiAoKGZsdXNoZXI6ICgpID0+IHZvaWQpID0+IHZvaWQpIHwgdW5kZWZpbmVkKTogdm9pZCB7XG5cdFx0LyogdHNsaW50OmRpc2FibGU6bm8tbnVsbC1rZXl3b3JkICovIC8vICdvbGQnIEFQSSB0b2xkIHlvdSB0byB1c2UgYG51bGxgIGluc3RlYWQgb2YgYHVuZGVmaW5lZGBcblx0XHRhc3NlcnQoc2NoZWR1bGVyID09PSB1bmRlZmluZWQgfHwgc2NoZWR1bGVyID09PSBudWxsIHx8IHR5cGVvZiBzY2hlZHVsZXIgPT09IFwiZnVuY3Rpb25cIik7XG5cdFx0LyogdHNsaW50OmVuYWJsZTpuby1udWxsLWtleXdvcmQgKi9cblx0XHR0aGlzLl9zY2hlZHVsZXIgPSBzY2hlZHVsZXI7XG5cdH1cblxuXHQvKipcblx0ICogRW5xdWV1ZSBjYWxsYmFjayB0byBiZSBleGVjdXRlZCBhcyBzb29uIGFzIHBvc3NpYmxlLCBidXQgb3V0c2lkZSBvZiB0aGVcblx0ICogY3VycmVudCBzdGFja2ZyYW1lLiBJdCBpcyBPSyB0byBlbnF1ZXVlIG5ldyBjYWxsYmFja3Mgd2hpbGUgdGhleSBhcmVcblx0ICogYmVpbmcgZXhlY3V0ZWQsIGluIHdoaWNoIGNhc2UgdGhleSB3aWxsIGFsbCBiZSBjYWxsZWQgYmVmb3JlIGhhbmRpbmdcblx0ICogYmFjayBjb250cm9sIHRvIHRoZSBob3N0IEpTIGVudmlyb25tZW50LlxuXHQgKlxuXHQgKiBAcGFyYW0gY2FsbGJhY2sgQ2FsbGJhY2sgdG8gYmUgZXhlY3V0ZWQgd2l0aCBnaXZlbiBhcmd1bWVudFxuXHQgKiBAcGFyYW0gYXJnICAgICAgQXJndW1lbnQgdG8gcGFzcyB0byBjYWxsYmFja1xuXHQgKi9cblx0cHVibGljIGVucXVldWUoY2FsbGJhY2s6ICgpID0+IHZvaWQpOiB2b2lkO1xuXHRwdWJsaWMgZW5xdWV1ZTxUPihjYWxsYmFjazogKGFyZzogVCkgPT4gdm9pZCwgYXJnOiBUKTogdm9pZDtcblx0cHVibGljIGVucXVldWUoY2FsbGJhY2s6IChhcmc6IGFueSkgPT4gdm9pZCwgYXJnPzogYW55KTogdm9pZCB7XG5cdFx0aWYgKCF0aGlzLl9mbHVzaGluZyAmJiAhdGhpcy5fc2NoZWR1bGVkKSB7XG5cdFx0XHR0aGlzLl9zY2hlZHVsZSgpO1xuXHRcdH1cblx0XHR0aGlzLl9tYWluUmluZy5lbnF1ZXVlKGNhbGxiYWNrLCBhcmcpO1xuXHR9XG5cblx0LyoqXG5cdCAqIEVucXVldWUgY2FsbGJhY2sgdG8gYmUgZXhlY3V0ZWQgYWZ0ZXIgYWxsIG90aGVyIGVucXVldWVkIGNhbGxiYWNrcyBoYXZlXG5cdCAqIGJlZW4gZXhlY3V0ZWQuXG5cdCAqIE9uY2UgdGhlIGlkbGUgY2FsbGJhY2tzIHN0YXJ0IHRvIGJlIGV4ZWN1dGVkLCB0aGF0ICdiYXRjaCcgb2YgaWRsZSBjYWxsYmFja3Ncblx0ICogd2lsbCBhbGwgYmUgZXhlY3V0ZWQgYmVmb3JlIGFueSBuZXdseSBlbnF1ZXVlZCBjYWxsYmFja3Mgd2lsbCBiZSBleGVjdXRlZC5cblx0ICpcblx0ICogQHBhcmFtIGNhbGxiYWNrIENhbGxiYWNrIHRvIGJlIGV4ZWN1dGVkIHdpdGggZ2l2ZW4gYXJndW1lbnRcblx0ICogQHBhcmFtIGFyZyAgICAgIEFyZ3VtZW50IHRvIHBhc3MgdG8gY2FsbGJhY2tcblx0ICovXG5cdHB1YmxpYyBlbnF1ZXVlSWRsZShjYWxsYmFjazogKCkgPT4gdm9pZCk6IHZvaWQ7XG5cdHB1YmxpYyBlbnF1ZXVlSWRsZTxUPihjYWxsYmFjazogKGFyZzogVCkgPT4gdm9pZCwgYXJnOiBUKTogdm9pZDtcblx0cHVibGljIGVucXVldWVJZGxlKGNhbGxiYWNrOiAoYXJnOiBhbnkpID0+IHZvaWQsIGFyZz86IGFueSk6IHZvaWQge1xuXHRcdGlmICghdGhpcy5fZmx1c2hpbmcgJiYgIXRoaXMuX3NjaGVkdWxlZCkge1xuXHRcdFx0dGhpcy5fc2NoZWR1bGUoKTtcblx0XHR9XG5cdFx0dGhpcy5faWRsZVJpbmcuZW5xdWV1ZShjYWxsYmFjaywgYXJnKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBGbHVzaCBjYWxsYmFjayBxdWV1ZXMuXG5cdCAqIEZpcnN0LCB0aGUgJ25vcm1hbCcgY2FsbGJhY2sgcXVldWVzIGFyZSBmbHVzaGVkIHVudGlsIHRoZXkgYXJlIGVtcHR5IChpLmUuXG5cdCAqIG5ldyBjYWxsYmFja3MgdGhhdCBhcmUgYWRkZWQgd2hpbGUgZXhlY3V0aW5nIHdpbGwgYWxzbyBiZSBwcm9jZXNzZWQpLlxuXHQgKiBUaGVuLCB0aGUgJ2lkbGUnIHF1ZXVlcyBhcmUgZmx1c2hlZCAoYWxzbyB1bnRpbCB0aGV5IGFyZSBlbXB0eSkuXG5cdCAqIEZsdXNoaW5nIHJlcGVhdHMgdW50aWwgbm8gbW9yZSBpdGVtcyBhcmUgZW5xdWV1ZWQgaW4gbm9ybWFsIG9yIGlkbGUgcXVldWVzLlxuXHQgKiBJdCBpcyBhbiBlcnJvciB0byBjYWxsIGZsdXNoIGZyb20gd2l0aGluIGFuIGVucXVldWVkIGNhbGxiYWNrLlxuXHQgKi9cblx0cHVibGljIGZsdXNoKCk6IHZvaWQge1xuXHRcdGFzc2VydCghdGhpcy5fZmx1c2hpbmcsIFwiY2Fubm90IHJlY3Vyc2l2ZWx5IGZsdXNoXCIpO1xuXHRcdHRoaXMuX2ZsdXNoaW5nID0gdHJ1ZTtcblx0XHR0cnkge1xuXHRcdFx0d2hpbGUgKHRydWUpIHtcblx0XHRcdFx0dGhpcy5fbWFpblJpbmcuZmx1c2goKTtcblx0XHRcdFx0aWYgKHRoaXMuX2lkbGVSaW5nLmVtcHR5KCkpIHtcblx0XHRcdFx0XHQvLyBCb3RoIHJpbmdzIG5vdyBlbXB0eTogZG9uZVxuXHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHR9XG5cdFx0XHRcdC8vIE1haW4gcmluZyBlbXB0eSwgaWRsZSByaW5nIG5vdCBlbXB0eS5cblx0XHRcdFx0Ly8gU3RhcnQgZmx1c2hpbmcgaWRsZSByaW5nLCBtYWtpbmcgc3VyZSBpdCBpcyBjb21wbGV0ZWx5XG5cdFx0XHRcdC8vIHByb2Nlc3NlZCBiZWZvcmUgcHJvY2Vzc2luZyBuZXcgJ25vcm1hbCcgY2FsbGJhY2tzIChldmVuXG5cdFx0XHRcdC8vIGlmIGl0IGlzIGludGVycnVwdGVkIGJ5IGEgdGhyb3duIGVycm9yIGluIG9uZSBvZiB0aGVtKS5cblx0XHRcdFx0Ly8gQWxzbywgbWFrZSBzdXJlIHRoYXQgYW55IG5ldyBub3JtYWwgY2FsbGJhY2tzIGFyZSBnb2luZ1xuXHRcdFx0XHQvLyB0byBiZSBwcm9jZXNzZWQgYmVmb3JlIGFueSBuZXcgaWRsZSBjYWxsYmFja3MuXG5cdFx0XHRcdGNvbnN0IGVtcHR5UmluZyA9IHRoaXMuX21haW5SaW5nO1xuXHRcdFx0XHR0aGlzLl9tYWluUmluZyA9IHRoaXMuX2lkbGVSaW5nO1xuXHRcdFx0XHR0aGlzLl9pZGxlUmluZyA9IGVtcHR5UmluZztcblx0XHRcdH1cblx0XHR9IGZpbmFsbHkge1xuXHRcdFx0dGhpcy5fZmx1c2hpbmcgPSBmYWxzZTtcblxuXHRcdFx0Ly8gSWYgb25lIG9mIHRoZSBjYWxsYmFja3MgaW4gdGhlIHF1ZXVlIHRocm93cyBhbiBleGNlcHRpb24sXG5cdFx0XHQvLyAoZS5nLiB3aGVuIFByb21pc2UjZG9uZSgpIGRldGVjdHMgYSByZWplY3Rpb24pIG1ha2Ugc3VyZSB0b1xuXHRcdFx0Ly8gcmVzY2hlZHVsZSB0aGUgcmVtYWluZGVyIG9mIHRoZSBxdWV1ZShzKSBmb3IgYW5vdGhlciBpdGVyYXRpb24uXG5cdFx0XHQvLyBUaGlzIGFwcHJvYWNoIGhhcyB0aGUgYWR2YW50YWdlIG9mIGltbWVkaWF0ZWx5IGFsbG93aW5nIHRvIHN0b3Bcblx0XHRcdC8vIHRoZSBwcm9ncmFtIGluIGUuZy4gTm9kZUpTLCBidXQgYWxzbyBhbGxvd3MgdG8gY29udGludWUgcnVubmluZ1xuXHRcdFx0Ly8gY29ycmVjdGx5IGluIGEgYnJvd3Nlci5cblx0XHRcdC8vIE5vdGU6IHdlIG1heSBiZSBjYWxsZWQgZXhwbGljaXRseSwgZXZlbiB0aG91Z2ggd2Ugd2VyZSBhbHNvXG5cdFx0XHQvLyBhbHJlYWR5IHNjaGVkdWxlZCwgYmVmb3JlLlxuXHRcdFx0aWYgKCghdGhpcy5fbWFpblJpbmcuZW1wdHkoKSB8fCAhdGhpcy5faWRsZVJpbmcuZW1wdHkoKSkgJiYgIXRoaXMuX3NjaGVkdWxlZCkge1xuXHRcdFx0XHR0aGlzLl9zY2hlZHVsZSgpO1xuXHRcdFx0fVxuXHRcdH1cblx0fVxuXG5cdHByaXZhdGUgX2ZsdXNoZXI6ICgpID0+IHZvaWQgPSAoKSA9PiB0aGlzLl9zY2hlZHVsZWRGbHVzaCgpO1xuXG5cdHByaXZhdGUgX3NjaGVkdWxlKCk6IHZvaWQge1xuXHRcdGFzc2VydCghdGhpcy5fc2NoZWR1bGVkKTtcblx0XHRjb25zdCBzY2hlZHVsZXIgPSB0aGlzLl9zY2hlZHVsZXIgfHwgZGVmYXVsdFNjaGVkdWxlcjtcblx0XHQvLyBDYWxsIHNjaGVkdWxlciB3aXRob3V0IGEgYHRoaXNgXG5cdFx0c2NoZWR1bGVyKHRoaXMuX2ZsdXNoZXIpO1xuXHRcdHRoaXMuX3NjaGVkdWxlZCA9IHRydWU7XG5cdH1cblxuXHRwcml2YXRlIF9zY2hlZHVsZWRGbHVzaCgpOiB2b2lkIHtcblx0XHQvLyBJbmRpY2F0ZSB0aGF0IHRoaXMgJ2l0ZXJhdGlvbicgb2YgdGhlIGZsdXNoIGlzIGNvbXBsZXRlLlxuXHRcdHRoaXMuX3NjaGVkdWxlZCA9IGZhbHNlO1xuXHRcdHRoaXMuZmx1c2goKTtcblx0fVxufVxuXG5leHBvcnQgbGV0IGFzeW5jID0gbmV3IEFzeW5jKCk7XG5leHBvcnQgZGVmYXVsdCBhc3luYztcbiJdfQ==